<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>临时邮箱 - 在线收发邮件</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        .container {
            max-width: 960px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .email-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .email-address {
            font-family: monospace;
            font-size: 18px;
            color: #333;
        }
        .copy-btn {
            margin-left: 10px;
        }
        .mail-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .mail-item {
            border-bottom: 1px solid #eee;
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .mail-item:hover {
            background-color: #f5f5f5;
        }
        .mail-item.unread {
            font-weight: bold;
        }
        .mail-subject {
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mail-from {
            font-size: 12px;
            color: #666;
        }
        .mail-date {
            font-size: 12px;
            color: #999;
        }
        .mail-content {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            min-height: 300px;
            display: none;
        }
        .no-mails {
            padding: 30px;
            text-align: center;
            color: #999;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
        }
        #refresh-time {
            width: 60px;
            margin: 0 10px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .domain-select {
            margin-bottom: 15px;
        }
        footer {
            margin-top: 40px;
            text-align: center;
            color: #888;
            font-size: 12px;
        }
        .tab-content {
            margin-top: 20px;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #email-iframe {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .mail-attachments {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .attachment-item {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #e9ecef;
            border-radius: 3px;
            font-size: 12px;
        }
        .attachment-item a {
            color: #333;
            text-decoration: none;
        }
        .refresh-button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>临时邮箱</h1>
            <p class="lead">即时创建临时邮箱，安全接收验证邮件</p>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox" type="button" role="tab" aria-controls="inbox" aria-selected="true">收件箱</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab" aria-controls="help" aria-selected="false">使用帮助</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="inbox" role="tabpanel" aria-labelledby="inbox-tab">
                <div class="row">
                    <div class="col-md-12">
                        <div class="email-box mb-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-2">你的临时邮箱地址:</div>
                                    <div class="d-flex align-items-center">
                                        <span id="email-address" class="email-address">等待生成...</span>
                                        <button id="copy-btn" class="btn btn-sm btn-outline-secondary copy-btn" disabled>复制</button>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button id="generate-btn" class="btn btn-primary">生成新邮箱</button>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="auto-refresh form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                                    <label class="form-check-label" for="auto-refresh">
                                        自动刷新邮箱
                                    </label>
                                    <input type="number" id="refresh-time" class="form-control form-control-sm" value="10" min="5" max="60">
                                    <span>秒</span>
                                    <button id="refresh-now" class="btn btn-sm btn-outline-primary refresh-button">立即刷新</button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <div id="last-update" class="text-muted small">上次更新: 未更新</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-5">
                                <div id="mail-list" class="mail-list">
                                    <div class="no-mails">暂无邮件，等待接收...</div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div id="mail-content" class="mail-content">
                                    <div class="text-center text-muted my-5">
                                        <i class="fas fa-envelope fa-3x mb-3"></i>
                                        <p>选择邮件查看内容</p>
                                    </div>
                                </div>
                                <iframe id="email-iframe" style="display:none"></iframe>
                            </div>
                        </div>

                        <div id="loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="help" role="tabpanel" aria-labelledby="help-tab">
                <div class="p-4">
                    <h3>临时邮箱使用帮助</h3>
                    
                    <h5 class="mt-4">什么是临时邮箱？</h5>
                    <p>临时邮箱是一种无需注册即可使用的电子邮箱服务。您可以立即获得一个临时的电子邮件地址，用于接收验证码、确认邮件等。</p>
                    
                    <h5 class="mt-4">如何使用？</h5>
                    <ol>
                        <li>点击"生成新邮箱"按钮获取一个临时邮箱地址</li>
                        <li>复制该邮箱地址，并用于您需要的网站或服务</li>
                        <li>系统会自动检查新邮件，您也可以手动点击"立即刷新"</li>
                        <li>收到邮件后，点击邮件即可查看内容</li>
                    </ol>
                    
                    <h5 class="mt-4">注意事项</h5>
                    <ul>
                        <li>临时邮箱有效期仅为24小时</li>
                        <li>该服务不保存您的邮件内容，关闭页面后邮件将无法恢复</li>
                        <li>请不要使用临时邮箱接收重要文件或信息</li>
                        <li>本服务仅用于接收邮件，不支持发送功能</li>
                    </ul>
                    
                    <h5 class="mt-4">API接口</h5>
                    <p>我们提供以下API接口供开发者使用：</p>
                    
                    <div class="mb-2">
                        <code>/api/generate-email</code> - 生成随机邮箱地址
                    </div>
                    <div class="mb-2">
                        <code>/api/domains</code> - 获取所有可用域名
                    </div>
                    <div class="mb-2">
                        <code>/api/mailbox/{email}</code> - 获取指定邮箱的邮件列表
                    </div>
                    <div class="mb-2">
                        <code>/api/message/{uid}</code> - 获取特定邮件的详情
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>临时邮箱服务 v1.0.0 | Powered by Cloudflare Workers</p>
            <p>本服务仅供学习和测试使用，请勿用于非法用途</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentEmail = null;
        let refreshInterval = null;
        let lastMailIds = [];
        
        // 元素引用
        const generateBtn = document.getElementById('generate-btn');
        const emailAddress = document.getElementById('email-address');
        const copyBtn = document.getElementById('copy-btn');
        const mailList = document.getElementById('mail-list');
        const mailContent = document.getElementById('mail-content');
        const emailIframe = document.getElementById('email-iframe');
        const loading = document.getElementById('loading');
        const autoRefresh = document.getElementById('auto-refresh');
        const refreshTime = document.getElementById('refresh-time');
        const refreshNow = document.getElementById('refresh-now');
        const lastUpdate = document.getElementById('last-update');

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 点击生成新邮箱
            generateBtn.addEventListener('click', generateNewEmail);
            
            // 复制邮箱地址
            copyBtn.addEventListener('click', copyEmailAddress);
            
            // 立即刷新
            refreshNow.addEventListener('click', checkMailbox);
            
            // 自动刷新设置变更
            autoRefresh.addEventListener('change', toggleAutoRefresh);
            refreshTime.addEventListener('change', updateRefreshTime);
            
            // 初始生成邮箱
            generateNewEmail();
            
            // 初始化自动刷新
            toggleAutoRefresh();
        });

        // 生成新邮箱
        async function generateNewEmail() {
            showLoading(true);
            try {
                const response = await fetch('/api/generate-email');
                const data = await response.json();
                
                if (data.success && data.email) {
                    currentEmail = data.email;
                    emailAddress.textContent = currentEmail;
                    copyBtn.disabled = false;
                    
                    // 清空邮件列表
                    mailList.innerHTML = '<div class="no-mails">暂无邮件，等待接收...</div>';
                    mailContent.style.display = 'none';
                    emailIframe.style.display = 'none';
                    
                    // 刷新检查时间
                    updateLastRefreshTime();
                    
                    // 第一次检查邮箱
                    checkMailbox();
                } else {
                    throw new Error('生成邮箱失败');
                }
            } catch (error) {
                console.error('生成邮箱出错:', error);
                alert('生成邮箱失败，请重试');
            } finally {
                showLoading(false);
            }
        }

        // 复制邮箱地址到剪贴板
        function copyEmailAddress() {
            if (currentEmail) {
                navigator.clipboard.writeText(currentEmail)
                    .then(() => {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = '已复制';
                        copyBtn.classList.add('btn-success');
                        copyBtn.classList.remove('btn-outline-secondary');
                        
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                            copyBtn.classList.remove('btn-success');
                            copyBtn.classList.add('btn-outline-secondary');
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制');
                    });
            }
        }

        // 检查邮箱
        async function checkMailbox() {
            if (!currentEmail) return;
            
            showLoading(true);
            try {
                const response = await fetch(`/api/mailbox/${encodeURIComponent(currentEmail)}`);
                const data = await response.json();
                
                if (data.success && data.messages) {
                    updateMailList(data.messages);
                    updateLastRefreshTime();
                } else {
                    console.error('获取邮件列表失败:', data);
                }
            } catch (error) {
                console.error('检查邮箱出错:', error);
            } finally {
                showLoading(false);
            }
        }

        // 更新邮件列表
        function updateMailList(messages) {
            if (!messages || messages.length === 0) {
                mailList.innerHTML = '<div class="no-mails">暂无邮件，等待接收...</div>';
                return;
            }
            
            // 检查是否有新邮件
            let hasNewMail = false;
            const currentMailIds = messages.map(mail => mail.id);
            
            if (lastMailIds.length > 0) {
                // 查找新邮件
                for (const id of currentMailIds) {
                    if (!lastMailIds.includes(id)) {
                        hasNewMail = true;
                        break;
                    }
                }
            }
            
            // 更新列表
            mailList.innerHTML = '';
            messages.forEach(mail => {
                const date = new Date(mail.timestamp * 1000);
                const formattedDate = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                const mailItem = document.createElement('div');
                mailItem.className = 'mail-item' + (mail.seen ? '' : ' unread');
                mailItem.setAttribute('data-id', mail.id);
                mailItem.innerHTML = `
                    <div class="mail-subject">${escapeHtml(mail.subject || '(无主题)')}</div>
                    <div class="d-flex justify-content-between">
                        <div class="mail-from">${escapeHtml(mail.from || '未知发件人')}</div>
                        <div class="mail-date">${formattedDate}</div>
                    </div>
                `;
                
                mailItem.addEventListener('click', () => viewMail(mail.id));
                mailList.appendChild(mailItem);
            });
            
            // 有新邮件时提醒
            if (hasNewMail && lastMailIds.length > 0) {
                notifyNewMail();
            }
            
            // 更新已知邮件ID列表
            lastMailIds = currentMailIds;
        }

        // 查看邮件内容
        async function viewMail(mailId) {
            showLoading(true);
            try {
                const response = await fetch(`/api/message/${mailId}`);
                const data = await response.json();
                
                if (data.success && data.message) {
                    const mail = data.message;
                    
                    // 高亮当前选中的邮件
                    const allItems = mailList.querySelectorAll('.mail-item');
                    allItems.forEach(item => item.classList.remove('active', 'bg-light'));
                    const currentItem = mailList.querySelector(`.mail-item[data-id="${mailId}"]`);
                    if (currentItem) {
                        currentItem.classList.add('active', 'bg-light');
                        currentItem.classList.remove('unread');
                    }
                    
                    // 使用iframe显示HTML内容
                    if (mail.html) {
                        emailIframe.style.display = 'block';
                        mailContent.style.display = 'none';
                        
                        const doc = emailIframe.contentDocument || emailIframe.contentWindow.document;
                        doc.open();
                        doc.write(mail.html);
                        doc.close();
                        
                        // 处理iframe中的链接，在新窗口打开
                        const links = doc.querySelectorAll('a');
                        links.forEach(link => {
                            link.setAttribute('target', '_blank');
                            link.setAttribute('rel', 'noopener noreferrer');
                        });
                    } else {
                        // 如果没有HTML内容，显示纯文本
                        emailIframe.style.display = 'none';
                        mailContent.style.display = 'block';
                        
                        // 格式化邮件内容
                        const date = new Date(mail.timestamp * 1000);
                        const formattedDate = date.toLocaleString();
                        
                        mailContent.innerHTML = `
                            <div class="mb-4">
                                <h5>${escapeHtml(mail.subject || '(无主题)')}</h5>
                                <div class="text-muted mb-2">
                                    <strong>发件人:</strong> ${escapeHtml(mail.from || '未知')}
                                </div>
                                <div class="text-muted mb-2">
                                    <strong>收件人:</strong> ${escapeHtml(mail.to || currentEmail)}
                                </div>
                                <div class="text-muted mb-4">
                                    <strong>时间:</strong> ${formattedDate}
                                </div>
                            </div>
                            <div class="mail-body">
                                ${formatMailBody(mail.text)}
                            </div>
                        `;
                        
                        // 添加附件(如果有)
                        if (mail.attachments && mail.attachments.length > 0) {
                            const attachmentsDiv = document.createElement('div');
                            attachmentsDiv.className = 'mail-attachments';
                            attachmentsDiv.innerHTML = '<div class="mb-2"><strong>附件:</strong></div>';
                            
                            mail.attachments.forEach(attachment => {
                                const attItem = document.createElement('div');
                                attItem.className = 'attachment-item';
                                attItem.innerHTML = `
                                    <i class="fas fa-paperclip"></i>
                                    <span>${escapeHtml(attachment.filename)}</span>
                                `;
                                attachmentsDiv.appendChild(attItem);
                            });
                            
                            mailContent.appendChild(attachmentsDiv);
                        }
                    }
                } else {
                    throw new Error('获取邮件失败');
                }
            } catch (error) {
                console.error('查看邮件出错:', error);
                alert('获取邮件内容失败，请重试');
            } finally {
                showLoading(false);
            }
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            if (autoRefresh.checked) {
                const seconds = parseInt(refreshTime.value) || 10;
                refreshInterval = setInterval(checkMailbox, seconds * 1000);
            } else {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
        }

        // 更新刷新时间
        function updateRefreshTime() {
            // 先清除旧的定时器
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            // 如果启用了自动刷新，创建新的定时器
            if (autoRefresh.checked) {
                const seconds = parseInt(refreshTime.value) || 10;
                refreshInterval = setInterval(checkMailbox, seconds * 1000);
            }
        }

        // 显示加载状态
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }

        // 更新最后刷新时间
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            lastUpdate.textContent = `上次更新: ${timeStr}`;
        }

        // 提醒新邮件
        function notifyNewMail() {
            // 如果浏览器支持通知
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('新邮件通知', {
                        body: '您的临时邮箱收到了新邮件',
                        icon: '/favicon.ico'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('新邮件通知', {
                                body: '您的临时邮箱收到了新邮件',
                                icon: '/favicon.ico'
                            });
                        }
                    });
                }
            }
            
            // 声音提示
const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
audio.play().catch(e => {
    console.log('自动播放被阻止', e);
    // 大多数浏览器需要用户交互后才能播放声音
});
}

// 格式化邮件内容
function formatMailBody(text) {
    if (!text) return '<p>（无内容）</p>';
    
    // 转义HTML
    text = escapeHtml(text);
    
    // 将URL转换为可点击的链接
    text = text.replace(
        /(https?:\/\/[^\s]+)/g, 
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
    );
    
    // 将换行符转换为<br>标签
    return '<p>' + text.replace(/\n/g, '</p><p>') + '</p>';
}

// HTML转义函数，防止XSS攻击
function escapeHtml(text) {
    if (!text) return '';
    
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    
    return text.replace(/[&<>"']/g, m => map[m]);
}

            </script>
</body>
</html>
